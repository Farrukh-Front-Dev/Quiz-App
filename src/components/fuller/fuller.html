<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Delete Duplicate Subjects</title>
</head>
<body class="p-4">
  <h1>Duplicate Subjects Remover</h1>
  <button id="deleteDuplicates">Check & Delete Duplicates</button>

  <script>
    const API_URL = "https://excellent-grade-test.onrender.com/subjects";

    async function fetchSubjects() {
      const res = await fetch(API_URL, { headers: { accept: "application/json" } });
      if (!res.ok) throw new Error("Subjects fetch error");
      const data = await res.json();
      return data.data; // API'dan subjects array
    }

    async function deleteSubject(id) {
      try {
        const res = await fetch(`${API_URL}/${id}`, {
          method: "DELETE",
          headers: { accept: "*/*" }
        });

        if (!res.ok) {
          console.error(`âŒ Delete failed for ID ${id}:`, await res.text());
        } else {
          console.log(`âœ… Deleted duplicate subject: ${id}`);
        }
      } catch (err) {
        console.error("Request error:", err);
      }
    }

    function findDuplicates(subjects) {
      const seen = new Map();
      const duplicates = [];

      for (const subject of subjects) {
        const key = subject.title.trim().toLowerCase();
        if (seen.has(key)) {
          duplicates.push(subject);
        } else {
          seen.set(key, subject.id);
        }
      }

      return duplicates;
    }

    document.getElementById("deleteDuplicates").addEventListener("click", async () => {
      try {
        const subjects = await fetchSubjects();
        const duplicates = findDuplicates(subjects);

        if (duplicates.length === 0) {
          alert("âœ… Dublikat fanlar topilmadi!");
          return;
        }

        console.log("ğŸ” Dublikatlar topildi:", duplicates);

        for (const dup of duplicates) {
          await deleteSubject(dup.id);
        }

        alert(`âœ… ${duplicates.length} ta dublikat o'chirildi! (Console tekshiring)`);
      } catch (error) {
        console.error("Xatolik:", error);
        alert("âŒ Subjectlarni olishda yoki o'chirishda xato!");
      }
    });
  </script>
</body>
</html>
